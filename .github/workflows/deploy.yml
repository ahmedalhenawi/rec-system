name: Deploy to Hostinger

on:
  push:
    branches:
      - main  # âš ï¸ ØªØ£ÙƒØ¯: Ù‡Ù„ Ø§Ø³Ù… Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ø¹Ù†Ø¯Ùƒ main Ø£Ùˆ masterØŸ (ØºØ§Ù„Ø¨Ø§Ù‹ main)

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸšš Get latest code
      uses: actions/checkout@v4

    - name: ğŸ˜ Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2' # ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§ Ø­Ø³Ø¨ Ù†Ø³Ø®Ø© Ù„Ø§Ø±Ø§ÙÙŠÙ„ Ø¹Ù†Ø¯Ùƒ

    - name: ğŸ“¦ Install Dependencies
      run: composer install -q --no-ansi --no-interaction --no-scripts --no-progress --prefer-dist

    - name: ğŸ“‚ Prepare files (Compress)
      run: |
        # Ù†Ø­Ø°Ù Ù…Ù„ÙØ§Øª git Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø­Ø¬Ù… ÙˆÙ…Ù†Ø¹ Ø§Ù…ØªÙ„Ø§Ø¡ Ø§Ù„Ù€ Inodes
        rm -rf .git
        rm -rf .github
        # Ù†Ø¶ØºØ· Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ÙÙŠ Ù…Ù„Ù ÙˆØ§Ø­Ø¯ Ø³Ø±ÙŠØ¹ Ø§Ù„Ù†Ù‚Ù„
        tar -czf project.tar.gz .

    - name: ğŸš€ Upload to Hostinger
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.HOSTINGER_SSH_HOST }}
        username: ${{ secrets.HOSTINGER_SSH_USER }}
        key: ${{ secrets.HOSTINGER_SSH_KEY }}
        port: 65002
        source: "project.tar.gz"
        # Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø°ÙŠ Ø§ÙƒØªØ´ÙÙ†Ø§Ù‡ Ø³ÙˆÙŠØ§Ù‹
        target: "/home/${{ secrets.HOSTINGER_SSH_USER }}/domains/so-rec.org/public_html"

    - name: ğŸ› ï¸ Extract & Configure on Server
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.HOSTINGER_SSH_HOST }}
        username: ${{ secrets.HOSTINGER_SSH_USER }}
        key: ${{ secrets.HOSTINGER_SSH_KEY }}
        port: 65002
        script: |
          # Ù†Ù†ØªÙ‚Ù„ Ù„Ù…Ø¬Ù„Ø¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹
          cd /home/${{ secrets.HOSTINGER_SSH_USER }}/domains/so-rec.org/public_html
          
          # ÙÙƒ Ø§Ù„Ø¶ØºØ· ÙˆØ§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ù…Ù„ÙØ§Øª
          tar -xzf project.tar.gz
          rm project.tar.gz
          
          # ØªØ´ØºÙŠÙ„ Ø£ÙˆØ§Ù…Ø± Ù„Ø§Ø±Ø§ÙÙŠÙ„ Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ©
          php artisan migrate --force
          php artisan optimize:clear
          php artisan config:cache
          php artisan route:cache
          php artisan view:cache
          
          # Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª (Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹ Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ù„ÙØ§Øª)
          chmod -R 775 storage bootstrap/cache
          chmod 755 public
